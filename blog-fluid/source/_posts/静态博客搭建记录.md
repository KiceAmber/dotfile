---
title: 静态博客搭建记录
date: 2022-08-03 13:15:21
tags: 
  - 博客
---

> 前置需求：一台阿里云服务器 + 本地主机

# 本地安装 Hexo 博客框架

这里本地下载 Hexo，为了能够在本地编辑博客内容，然后将内容推送到服务器的 git 仓库

```shell
npm install -g hexo-cli
```

初始化博客文件夹，这里我在 `~/Public/Hexo` 下新建了 `blog` 文件夹

```shell
mkdir ~/Public/Hexo/blog

cd ~/Public/Hexo/blog

hexo init 

npm insatll
```

完成上述步骤后，输入 `hexo s` 即可启动本地服务，访问 `localhost:4000` 就可以看到初始的博客界面

# 本地主机配置 git 密钥

因为要在服务器上搭建一个 git 仓库，然后该仓库需要使用 git 密钥来推送本地的数据到服务器

```shell
git config --global user.name "要设置的名字"

git config --global user.email "要设置的邮箱"

ssh-keygen -t rsa -C "刚刚设置的邮箱"
```

生成密钥会有很多选项需要选择，直接全部回车即可

现在密钥就保存在 `~/.ssh` 目录下的 `id_rs` 和 `id_rsa.pub` 这两个文件，前者为私钥，后者为公钥

# 配置服务器的 git

> 阿里云的服务器使用的操作系统是 `Ubuntu 20.04`

首先是要安装 git

```shell
sudo apt install git
```

然后创建 git 用户

```shell
adduser git

# 添加 git 账户权限
chmod 740 /etc/sudoers
vim /etc/sudoers
```

取消注释 root 那一行的内容，也就是这样

```shell
# User privilege specification
root    ALL=(ALL:ALL) ALL
```

然后给 git 用户添加权限，就是在文件末尾添加下面的内容

```shell file:"/etc/sudoers"
git    ALL=(ALL)    ALL
```

现在重新将 `/etc/sudoers` 文件的权限修改回来，防止误修改 `chmod 400 /etc/sudoers`

然后切换到 git 用户，进行密钥的生成与配置

```shell
su git

mkdir ~/.ssh

vim ~/.ssh/authorized_keys
```

现在将主机上的 `id_rsa.pub` 文件的内容复制到 `authorized_keys` 文件中，保存退出

修改文件权限

```shell
chmod 600 /home/git/.ssh/authorized_keys
chmod 700 /home/git/.ssh
```

现在可以在本地主机测试是否可以免密登录远程服务器

```shell
ssh -v git@服务器IP地址
```

如果测试成功，则会以服务器的 git 用户登录

# 配置远程服务器的仓库

这里的仓库指的的是用 git 搭建的私有仓库，以后推送的数据都是往远程服务器上推送，可以把远程服务器理解为 github 了，这其实就是人们常说的私服

同时先组织一下仓库的存储规范：

- `/var/repo`：用于 git 管理的仓库，保存了提交记录以及分支信息等
- `/var/hexo`：用于展示的页面，该目录下必须含有 `index.html` 文件，也就是博客的首页

不过上述两个目录都不需要自己手动编辑，只需要做好下面的步骤，里面的内容会自动修改

```shell
mkdir /var/repo
chmod -R 755 /var/repo

mkdir /var/hexo
chown -R git:git /var/hexo
chmod -R 755 /var/hexo

cd /var/repo
git init --bare hexo.git
```

创建 git-hooks 钩子文件，用来自动推送更新

```shell
vim /var/repo/hexo.git/hooks/post-receive
```

填入下面的内容

```shell
#!/bin/bash
git --work-tree=/var/hexo --git-dir=/var/repo/hexo.git checkout -f
```

然后修改该钩子文件的权限

```shell
chown -R git:git /var/repo/hexo.git/hooks/post-receive
chmod +x /var/repo/hexo.git/hooks/post-receive
```

# 配置 Nginx

```shell
sudo apt install nginx
```

现在需要配置 Nginx，将访问服务器的请求发送给 80 端口，这样可以默认显示博客文章首页

建议将站点的配置单独存放，创建一个新的 Nginx 站点配置文件 `/etc/nginx/sites-available/hexo`，在该文件中加入下面的内容：

```conf
server {
    listen 80;
    server_name your_domain.com;  # 替换为你的域名或服务器 IP 地址

    root /var/hexo; 
    index index.html; # 这里就会找到 `/var/hexo/index.html` 作为网页显示

    location / {
        try_files $uri $uri/ =404;
    }
}
```

然后创建硬链接，检查语法是否正确，重新加载 Nginx 的配置文件

```shell
sudo ln -s /etc/nginx/sites-available/hexo /etc/nginx/sites-enabled/

sudo nginx -t # 检测 nginx 语法是否填写正确

sudo systemctl reload nginx
```

> 这个地方出了问题，需要重新安装 Nginx
>
> ```shell
> sudo systemctl stop nginx 
> sudo apt purge nginx nginx-common
> sudo rm -rf /etc/nginx
> 
> sudo apt autoremove
> sudo apt autoclean
>
> sudo apt update
> sudo apt install nginx
> 
> sudo systemctl start nginx
> ```

# 配置本地主机的 Hexo

首先要修改 hexo 配置文件 `_config.yml`，找到 `deploy` 部分，修改为如下内容

```yaml
deploy:
  type: git
  repo: git@服务器IP地址:/var/repo/hexo.git
  branch: master
```

然后现在就可以使用 `hexo d` 来将本地编写的内容数据推送到远程服务器了

```shell
hexo clean && hexo d
```

> 如果提示 *ERROR Deployer not found: git*，那么就是没有安装部署插件，下面的命令安装该插件
>
> ```shell
> npm install hexo-deployer-git --save
> ```

有可能会因为权限问题，会出现这样的问题 *错误：远程解包失败：unable to create temporary object directory*

只需要在服务器上修改一下权限即可

```shell
chown -R git:git /var/repo/
chown -R git:git /var/hexo/
```

# 更换 Hexo 主题

> Hexo 主题链接：https://github.com/fluid-dev/hexo-theme-fluid

下载最新版本的 [realease](https://github.com/fluid-dev/hexo-theme-fluid/releases) 解压到博客根目录下的 themes 目录，并重命名为 fluid

修改博客根目录下的 `_config.yml` 文件，修改主题以及语言：

```yaml
theme: fluid  # 指定主题

language: zh-CN  # 指定语言，会影响主题显示的语言，按需修改
```

最后将 fluid 主题下的的配置文件 `_config.fluid.yml` 复制一份到博客根目录下，并将初始主题的 `_config.landscape.yml` 文件删除

最后博客根目录下的文件夹结构如下所示：

```shell
.
├── _config.fluid.yml
├── _config.yml
├── db.json
├── node_modules
├── package.json
├── package-lock.json
├── public
├── scaffolds
├── source
└── themes
```

fluid 主题自定义文档：https://hexo.fluid-dev.com/docs/guide/

# 博客搭建总结

上述的所有内容总结下来，博客的搭建以及推送机制如下：

- 本地安装 Hexo 框架，用于配置和编写博客文章
- 远程服务器搭建 git 私有仓库，由 git 管理仓库的运行以及更新
- 本地编写好文章后使用 `hexo d` 将文章推送到远程的 git 私有仓库
- 远程服务器再根据 git 仓库中的钩子文件，将博客文章由 `/var/repo` 目录复制到 `/var/hexo` 目录下，实现文章内容刷新
- 当外部请求访问到服务器域名时，由 Nginx 根据路由规则显示 `/var/hexo` 下的页面信息，从而让用户看到博客内容

